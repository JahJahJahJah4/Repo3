import { useState, useEffect, useRef } from "react";
import mapboxgl from "mapbox-gl";
import "mapbox-gl/dist/mapbox-gl.css";

const sampleEvents = [
  {
    id: 1,
    name: "Pulse Club",
    time: "10:30 PM",
    trail: "Neon Nights",
    coordinates: [-87.624, 41.891]
  },
  {
    id: 2,
    name: "Orbit Lounge",
    time: "11:00 PM",
    trail: "Neon Nights",
    coordinates: [-87.628, 41.892]
  },
  {
    id: 3,
    name: "Terminal X",
    time: "11:45 PM",
    trail: "Neon Nights",
    coordinates: [-87.63, 41.894]
  }
];

const trailPoints = [
  {
    id: 1,
    name: "Start - Night Gate",
    coordinates: [-87.6202, 41.8885]
  },
  {
    id: 2,
    name: "Midpoint - Violet Bar",
    coordinates: [-87.6225, 41.8892]
  },
  {
    id: 3,
    name: "End - Electric Finish",
    coordinates: [-87.625, 41.8903]
  }
];

const MAPBOX_TOKEN = "pk.eyJ1IjoiamFtZWVsYWs5MyIsImEiOiJja3luZ29hc2MwcDU2MnBycHg3NHprdmVuIn0.-CLDo6kpsFt7k7QzIPvHJQ";
mapboxgl.accessToken = MAPBOX_TOKEN;
const LOADING_GIF = "https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif";
const IMAGE_API = "https://prod-44.westus.logic.azure.com:443/workflows/bae271e6ed5b4cd39b21011746a58ab1/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jVCUiSPAD3i7Ub1Z6KPf5TjW5PJXFWlz8EFn8lltEHg";

function InlineMap({ pins, focus }) {
  const mapRef = useRef(null);
  const mapContainer = useRef(null);

  useEffect(() => {
    if (mapRef.current) return;
    const map = new mapboxgl.Map({
      container: mapContainer.current,
      style: "mapbox://styles/mapbox/streets-v11",
      center: focus?.coordinates || [-87.623, 41.889],
      zoom: 15,
      pitch: 45,
      bearing: -17,
      antialias: true
    });
    mapRef.current = map;
    map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), "top-right");
    return () => {
      map.remove();
      mapRef.current = null;
    };
  }, []);

  // Handle pins and focus updates
  useEffect(() => {
    const map = mapRef.current;
    if (!map) return;

    // Remove old markers
    if (map._markers) {
      map._markers.forEach(m => m.remove());
    }
    // Add new markers
    map._markers = pins.map(p =>
      new mapboxgl.Marker({ color: (focus && focus.id === p.id) ? "#FF0" : "#00FFE0" })
        .setLngLat(p.coordinates)
        .addTo(map)
    );
    if (focus) {
      map.flyTo({ center: focus.coordinates, zoom: 16 });
    }
  }, [pins, focus]);

  return <div ref={mapContainer} className="w-full h-[260px] rounded-xl overflow-hidden border border-[#00FFE0] mb-2" />;
}

export default function TempoScapeMobile() {
  const [activeTab, setActiveTab] = useState("events"); // or "trails"
  const [currentIndex, setCurrentIndex] = useState(0);
  const [imageSrc, setImageSrc] = useState(LOADING_GIF);
  const [isLoading, setIsLoading] = useState(true);

  // Dynamic data based on tab
  const data = activeTab === "events" ? sampleEvents : trailPoints;
  const focusItem = data[currentIndex];

  // Fetch image via GET with ?id=
  useEffect(() => {
    let ignore = false;
    async function fetchPoster() {
      setIsLoading(true);
      setImageSrc(LOADING_GIF);
      try {
        const res = await fetch(`${IMAGE_API}&id=${focusItem.id}`);
        if (!res.ok) throw new Error("API failed: " + res.status);
        const data = await res.json();
        if (data.url && data.url.startsWith("http")) {
          if (!ignore) setImageSrc(data.url);
        } else {
          if (!ignore) setImageSrc(LOADING_GIF);
        }
      } catch (e) {
        if (!ignore) setImageSrc(LOADING_GIF);
      } finally {
        if (!ignore) setIsLoading(false);
      }
    }
    if (focusItem && focusItem.id) fetchPoster();
    return () => { ignore = true; };
  }, [focusItem]);

  // Card navigation
  const handleSwipe = (direction) => {
    setCurrentIndex(prev => {
      let newIndex = direction === "left" ? prev + 1 : prev - 1;
      if (newIndex < 0) newIndex = data.length - 1;
      if (newIndex >= data.length) newIndex = 0;
      return newIndex;
    });
  };

  return (
    <div className="bg-[#0C0C0C] min-h-screen text-white font-sans flex flex-col p-2">
      <div className="text-center text-3xl font-bold text-[#00FFE0] mb-2">TEMPO TRAILS</div>
      <div className="flex justify-center mb-2">
        <button onClick={() => { setActiveTab("events"); setCurrentIndex(0); }}>Events</button>
        <button onClick={() => { setActiveTab("trails"); setCurrentIndex(0); }} className="ml-4">Trails</button>
      </div>
      <InlineMap pins={data} focus={focusItem} />
      <div className="relative h-[340px] w-full border border-[#00FFE0] rounded-xl overflow-hidden">
        <img
          src={imageSrc}
          alt="Event Poster"
          className="object-cover w-full h-full"
          style={{ minHeight: 300, background: "#222" }}
        />
        <div className="absolute top-1/2 left-0 transform -translate-y-1/2 w-full flex justify-between px-4">
          <button onClick={() => handleSwipe("right")} className="text-4xl text-white">←</button>
          <button onClick={() => handleSwipe("left")} className="text-4xl text-white">→</button>
        </div>
      </div>
      <div className="text-center mt-2 text-lg">{focusItem?.name}</div>
      <div className="text-center text-sm text-[#B4FFD2]">{focusItem?.time || ""}</div>
    </div>
  );
}
